# Gate-controller-based-on-ATmega8
Це проект контролера для відкатних або розпашних воріт.

Дем’янчук Т. М.
Лебедев Д.Ю., к.т.н.,










РОЗРОБКА КОНТРОЛЕРА ВІДКАТНИХ-РОЗПАШНИХ ВОРІТ
Національний технічний університет України
«Київський політехнічний інститут імені Ігоря Сікорського»













Дем’янчук Тарас Миколайович
demyanchuktaras23@gmail.com
   У даній статті описано процес розробки контролера відкатних-розпашних воріт, побудованого на базі 8-бітного мікроконтролера ATMEGA8 сімейства AVR. Даний контролер має ряд переваг у порівняні з іншими рішеннями на ринку. Для прикладу:
1.	Можливість працювати із 3 типами кінцевих вимикачів
2.	Наявність 2 пар виводів для підключення 2 додаткових реле, якими можна керувати віддалено кнопками C та D на пульті дистанційного керування
3.	Управління брамою здійснюється двома кнопками на пульті дистанційного керування (у аналогів на ринку лише одна кнопка керування), що дозволяє не втрачати час на додаткові натискання кнопок пульта керування
4.	Відсутність потреби використовувати зворотні діоди для реле, оскільки останні розпаяні на самій платі контролера
5.	Мікроконтролер реагує на надходження сигналу лише низького рівня, що дозволяє уникнути випадкового його реагування на наведену електростатичну напругу радіохвиль
6.	Наявність світлового та звукового оповіщення руху брами


Вступ
   Ми звикли користуватися девайсами, які спрощують наше життя. Маючи відкатні-розпашні ворота у себе вдома, інколи постає потреба відкрити їх в той час, коли на вулиці йде дощ, а виходити з машини в таку погоду зовсім не хочеться. У результаті ситуації, яка склалася, постає питання – постійно відкривати ворота вручну чи піти більш інноваційним шляхом, зробивши свої ворота автоматичними? Для вирішення цього питання був розроблений контролер відкатних-розпашних воріт для системи SMARTHOME, що дозволяє натисканням кнопки відкрити останні. 


Схема контролера
 

Блок LIMITSWITCH
   Блок LIMITSWITCH -  це блок виводів (Рис. 2 блок а, б) для підключення кінцевих вимикачів. Коли на контролер подано живлення, він перебуває в режимі постійно очікування сигналів ззовні. У випадку використання механічних кінцевиків, виводи OPEN/CLOSE замикаються (або розмикаються у разі використання нормально замкнених кінцевиків) в результаті чого, відповідні виводи на платі контролера замикаються/розмикаються, а якщо це стається, то порт  мікроконтролера, який відповідає за зупинку брами у разі досягнення нею крайнього положення, підтягується на шину землі (або відпускається, якщо використовуються нормально замкнені кінцеві вимикачі). Контролер фіксує зміну сигналу (оскільки порт налаштований на вхід з підтягуючим резистором на шину +5V) і вимикає реле, тим самим зупиняючи браму.
   Якщо ж контролер налаштований на використання магнітних (безконтактних) кінцевих вимикачів, то на виводи  HALL приходять два високі рівні від самого магнітного кінцевика. Далі, ці рівні надходять на дві оптопари, які підтягують відповідні виводи мікроконтролера на шину землі, якщо магнітний кінцевик спрацьовує, то одна з оптопар перестає підтягувати один із виводів мікроконтролера на шину землі. Далі, мікроконтролер обробляє різницю логічних рівнів між двома своїми виводами і в залежності від результату, який поверне функція алгоритму, буде вимкнене те чи інше реле, що призведе до зупинки брами. Виводи OUT_5V  потрібні для живлення магнітного кінцевика.
























Блок LASER_SENSOR
   Блок LASER_SENSOR - це пара виводів (Рис. 7 блок в) для підключення інфрачервоного датчика перешкод. Коли датчик фіксує перешкоду, він подає струм на реле, в результаті чого виводи реле замикаютсься і ці ж виводи замикають пару контактів LASER на платі контролера. Якщо виводи LASER замкнені, то це означає, що порт  мікроконтролера, який відповідає за зупинку брами у разі виявлення перешкоди, підтягується на шину землі і контролер вимикає одне з реле, яке відповідає за рух брами, після чого -брама зупиняється. Також, якщо датчик фіксує перешкоду, то контролер вмикає сигнальну лампу та зумер.


Блок RC (Рис. 3)
   Для того, щоб відкрити\закрити браму чи включити або виключити додаткові реле, потрібно на пульті керування натиснути на відповідну кнопку. Далі, радіосигнал від пульта керування (який працює  на частоті 433MHz) надходить до плати приймача. На платі приймача є 7 контактів, 2 контакти на живлення (+5V), наступні 4 контакти є сигнальними контактами і ще 1 для додаткової кнопки програмування модуля радіозв’язку (одна кнопка вже є розпаяною на самому радіо модулі). На сигнальному контакті плати приймача, при нажаті кнопки на пульті керування, з’являється високий логічний рівень (+5V), який далі потрапляє на пару Дарлінгтона (Рис. 4). Кожен із сигнальних контактів підключається до відповідного виводу пари Дарлінгтона.


Блок CONVERTER_RC
   Оскільки при роботі з портами мікроконтролера, краще їх налаштовувати на вхід з внутрішнім підтягуючим резистором на +5V, щоб на його виводах не наводилася напруга від радіохвиль і для того, щоб він зафіксував надходження зовнішнього сигналу на його порт потрібно подати сигнал низького рівня тобто підтягнути його на шину землі, то для  конвертування високого рівня сигналу від плати радіо модуля в сигнал низького рівня була задіяна пара Дарлінгтона (Рис. 4). Подаючи +5V на вхід пари Дарлінгтона (наприклад на 1B), відповідний її вихід (1C) транзистором NPN-структури підтягується на шину землі, тим самим створюючи на цьому виході сигнал низького рівня, далі цей сигнал надходить на визначений порт мікроконтролера, який він уже може зафіксувати.


Блок PROGRAMMING_BUTTON
   Блок PROGRAMMINGBUTTON - це кнопка (Рис. 7 блок д), розпаяна на платі контролера, яка потрібна для перепрограмування контролера на роботу з іншим типом кінцевого вимикача (нормально замкнений, нормально розімкнений, магнітний)








Блок CPU
   Блок CPU - це мікроконтролер ATMEGA8 (Рис. 5) фірми ATMEL, який виконує завантажену в нього програму. Мікроконтролер працює на частоті 16MHz завдяки кварцевому резонатору, розпаяному на платі контролера.






Блок CONVERTER_RL
   Блок CONVERTER_RL - це ще одна пара Дарлінгтона (Рис. 4) на платі контролера, яка задіяна з метою конвертування високого рівня +5V мікроконтролера ATMEGA8 у високий рівень +12-24V (в залежності від напруги яка подається для живлення плати контролера), який потрібен для живлення обмоток реле блока RELAY. В той момент, коли на вхід  пари Дарлінгтона (наприклад 1B) надходить високий рівень сигналу +5V, то відповідний вихід пари Дарлінгтона (1C) підятягується транзистором NPN-структури на шину землі, а оскільки всі виводи реле мають один спільний контакт, який підключається на вивід +POWER, то через обмотку реле, яка під'єднана одним виводом на вихід пари Дарлінгтона (1B), а другим виводом до +POWER, починає йти струм, в результаті чого реле замикається. 
 


Блок RELAY
   Блок RELAY - це 5 пар виводів (Рис. 7 блок г), потрібних для підключення реле. На платі контролера є розпаяні зворотні діоди, які захистять компоненти схеми від високовольтного викиду самоіндукції котушок реле.












































Алгоритм роботи контролера та його налаштування
   Після подачі живлення на плату контролера, викликається функція затримки, впродовж виконання якої (не більше 4 секунд), контролер не реагує на надходження будь-яких зовнішніх сигналів. Після сплину 4 секунд, плата контролера стає активною і перебуває в режимі постійного очікування зовнішнього сигналу від пульта керування, кнопки перепрограмування або кінцевих вимикачів чи датчика перешкод. 
При натисканні кнопки (наприклад A) на пульті дистанційного керування, контролер подає високий сигнал на пару Дарлінгтона (яка і керує всіма п’ятьма реле) і замикається реле, яке відповідає за відкриття брами, а також вмикається сигнальна лампа та зумер з частотою X Hz. Під час відкриття брами, кнопка B, яка відповідає за закриття брами, стає неактивною до тих пір, поки брама рухається. Якщо в процесі руху брами в будь-яку сторону інфрачервоний датчик перешкод фіксує перешкоду на шляху руху брами, то датчик подає низький сигнал на контролер, в результаті чого контролер перестає подавати високий рівень сигналу на пару Дарлінгтона, а пара Дарлінгтона, в свою чергу, перестає подавати струм на обмотку одного з двох реле, також, в цей момент вмикається сигнальна лампа та зумер з частотою X+Y Hz,  і контролер більше не увімкне жодного з двох реле, які відповідають за рух брами, до тих пір, поки перешкода не зникне і не прийде сигнал від пульта керування. Якщо інфрачервоний датчик перешкод не фіксує перешкоди, то брама буде рухатись до тих пір, поки не спрацює кінцевий вимикач. В тому випадку, якщо в процесі відкриття брами буде повторно нажата кнопка A, то брама зупиниться і контролер не буде реагувати на натискання кнопки B впродовж 2 секунд (це зроблено для того, щоб після виключення одного з реле, яке відповідає за рух брами в ту чи іншу сторону, брама зупинилась до того, як буде натиснута кнопка на пульті дистанційного керування, яка відповідає за рух брами в протилежному напрямку).
   При нажаті кнопки C чи D, на пульті дистанційного керування, контролер подає високий сигнал на пару Дарлінгтона, а вона в свою чергу подає високий сигнал на одне з двох додаткових реле. Сигнал на цих реле не буде змінюватись при надходженні на контролер сигналу від кінцевих вимикачів інфрачервоного датчика перешкод чи при нажаті кнопок A чи B!
   Для зміни типу кінцевого вимикача, з  яким буде працювати контролер, потрібно 5 разів натиснути на кнопку програмування, а щоб дізнатися з яким типом кінцевого вимикача працює контролер на даний момент, потрібно впродовж 2 секунд тиснути на кнопку програмування, якщо контролер налаштований на роботу з першим типом кінцевого вимикача, то зумер включиться 1 раз, якщо ж на другий - 2 рази.











Алгоритм роботи контролера 



Функція відкриття брами
 


Функція закриття брами

 


Функція з алгоритму зміни типу кінцевого вимикача
 













Параметри контролера
1.	Живлення контролера: рекомендовано блок живлення на 12-24V струмом 2A.
2.	Загальний струм споживання всіх реле не повинен перевищувати 2A! (рекомендовано не більше 1.5A)
3.	Розміри плати контролера: 90x80мм


Підключення периферії
   Механічні та магнітні кінцеві вимикачі, а також датчик перешкод, підключаються на виводи контролера, показані нижче.  Магнітний кінцевий  вимикач червоним та чорним виводами, підключається на виводи OUT_5V (червоний на +5V, чорний на -5V), два виводи, які залишились, під'єднуються до виводів HALL (якщо брама при використані магнітних кінцевих вимикачів не зупиняється при досягненні кінцевого положення, потрібно поміняти місцями два проводи, які йдуть від кінцевого вимикача на виводи HALL)


 


Висновки
   Ціль було досягнуто. В результаті роботи було створено багатофункціональний контролер відкатних-розпашних воріт на базі мікроконтролера  ATMEGA8. Надалі, планується розробка контролера з наступними властивостями:
1.	Контролер буде мати розпаяну на платі схему понижуючого перетворювача напруги з 110-220Вольт в 12-24 Вольта, необхідних для роботи контролера
2.	Власник матиме можливість керувати воротами через застосунок для смартфона та/або через GPS/GPRS-модуль радіозв’язку
3.	Контролер матиме інтерфейс користувача, завдяки якому можна буде налаштувати всі наявні функції
4.	Контролер матиме годинник реального часу, завдяки якому власник зможе налаштувати (через інтерфейс користувача) включення двох додаткових реле не тільки натисканням кнопки на пульті дистанційного керування, а ще й у визначений час. Також, годинник працюватиме від акумулятора, тож його не доведеться наводити повторно у разі вимкнення світла, так, як це було б у випадку із годинником, який  працював би від спільного джерела живлення
5.	На платі контролера вже будуть розпаяні реле, які відповідають за рух брами
6.	Планується розробка системи розумного дому SMARTHOME. Тому, контролер також матиме можливість безпровідного обміну інформацією із цією системою 










Фото контролера
 


 




Використана  література
1.	ATMEGA8 (Рис. 5):
[https://www.microchip.com/en-us/product/ATmega8A] 
2.	Трамперт  В. AVR-RISK микроконтроллеры.: Пер. С нем. – К.: ‘‘МК-Прес’’, 2006. 464 с., ил. ISBN 966-8806-07-7
3.	Схемотехника аналоговых и аналого-цифровых электронных устройств. – М.: Издательский дом «Додэка-XXI», 2005. – 528 с. ISBN 5-94120-074-9




	
